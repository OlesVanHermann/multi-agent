# Mise à jour v2.0 → v2.1

**Date:** Janvier 2026

---

## Résumé des changements

La v2.1 introduit le **Bridge Redis Streams** pour une communication plus robuste entre les agents et Claude Code.

### Nouveautés
- Communication via Redis Streams (XREAD/XADD) au lieu de Redis Lists
- Sessions Claude persistantes avec prompt caching (~90% économie tokens)
- Healthcheck et monitoring en temps réel
- Scripts CLI améliorés

---

## Nouveaux fichiers

```
core/agent-bridge/              # Bridge Redis Streams
├── __init__.py
├── agent.py                    # Agent principal
├── orchestrator.py             # Workflows (seq, par, review)
└── healthcheck.py              # Monitoring des agents

scripts/                        # Scripts CLI
├── start.sh                    # Démarrer les agents
├── stop.sh                     # Arrêter les agents
├── send.sh                     # Envoyer un message
├── watch.sh                    # Voir les réponses
└── monitor.py                  # Dashboard temps réel

docs/BRIDGE.md                  # Documentation technique
UPGRADE.md                      # Guide de mise à jour (ce système)
upgrades/                       # Guides par version
```

---

## Fichiers modifiés

| Fichier | Changement |
|---------|------------|
| `requirements.txt` | Ajout: `pexpect>=4.8.0` |
| `README.md` | Documentation v2.1, nouveaux scripts |
| `CLAUDE.md` | Référence au bridge |
| `prompts/CONVENTIONS.md` | Simplification mapping profiles |
| `prompts/600-release.md` | Chemins génériques (`$RELEASE_REPO`) |
| `prompts/900-architect.md` | Chemins auto-détectés |

---

## Actions requises

### 0. Télécharger le script de mise à jour

Le script `upgrade.sh` n'existe pas en v2.0. Téléchargez-le d'abord :

```bash
cd /chemin/vers/multi-agent   # Votre installation v2.0

curl -O https://raw.githubusercontent.com/OlesVanHermann/multi-agent/main/upgrade.sh
chmod +x upgrade.sh

# Lancer la mise à jour (fait un backup complet avant)
./upgrade.sh
```

### 1. Installer les nouvelles dépendances

```bash
pip install pexpect>=4.8.0
```

Ou :
```bash
pip install -r requirements.txt
```

### 2. Configurer l'environnement Claude

Si vous utilisez un profil Claude personnalisé :

```bash
# Dans votre .bashrc ou .zshrc
export CLAUDE_CONFIG_DIR=~/.claude

# Ou pour un profil spécifique
export CLAUDE_CONFIG_DIR=~/.claude-profiles/mon-profil
```

### 3. Vérifier Redis

```bash
redis-cli ping
# Doit répondre: PONG
```

### 4. Tester le nouveau bridge

```bash
# Lancer un agent en mode interactif
./scripts/agent.sh start 300

# Dans un autre terminal, envoyer un message
./scripts/send.sh 300 "ping"

# Voir la réponse
./scripts/watch.sh 300
```

### 5. Migrer vers les nouveaux scripts (optionnel)

Les anciens scripts (`scripts/start-agents.sh`) fonctionnent toujours.

Pour utiliser le nouveau bridge :

```bash
# Ancien
./scripts/start-agents.sh

# Nouveau
./scripts/agent.sh start all
```

---

## Compatibilité

| Composant | v2.0 | v2.1 | Notes |
|-----------|------|------|-------|
| `scripts/start-agents.sh` | ✅ | ✅ | Toujours fonctionnel |
| `scripts/*` | ❌ | ✅ | Nouveau |
| `core/agent-runner/` | ✅ | ✅ | Toujours fonctionnel |
| `core/agent-bridge/` | ❌ | ✅ | Nouveau |
| Prompts existants | ✅ | ✅ | Compatibles |

**Aucune modification de vos prompts n'est nécessaire** pour cette mise à jour.

---

## Rollback

Si vous devez revenir à la v2.0 :

```bash
# Via Git
git checkout v2.0

# Ou manuellement
mkdir -p removed
TS=$(date +%s)
mv core/agent-bridge/ removed/agent-bridge.$TS/
# scripts/ est maintenant à la racine
mv docs/BRIDGE.md removed/BRIDGE.md.$TS
git checkout HEAD~2 -- requirements.txt README.md CLAUDE.md
```

---

## Vérification post-mise à jour

```bash
# 1. Healthcheck
python3 core/agent-bridge/healthcheck.py

# 2. Test d'un agent
./scripts/agent.sh start 300
# (dans un autre terminal)
./scripts/send.sh 300 "status"
./scripts/watch.sh 300

# 3. Arrêter
./scripts/infra.sh stop
```

Résultat attendu du healthcheck :
```
Agent 300: idle (last seen: 2s ago)
```

---

## Problèmes connus

### "Invalid API key" dans tmux

**Cause:** La variable `CLAUDE_CONFIG_DIR` n'est pas passée aux sessions tmux.

**Solution:** Définir la variable avant de lancer les agents :
```bash
export CLAUDE_CONFIG_DIR=~/.claude
./scripts/agent.sh start all
```

### Agent bloqué sur "BUSY"

**Cause:** Claude Code n'a pas répondu dans le timeout (5 min).

**Solution:**
```bash
# Arrêter l'agent
./scripts/infra.sh stop

# Vider Redis
redis-cli FLUSHDB

# Redémarrer
./scripts/agent.sh start all
```

---

*Voir [UPGRADE.md](../UPGRADE.md) pour le processus général de mise à jour.*
